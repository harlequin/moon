"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[69071],{2861:e=>{e.exports=JSON.parse('{"permalink":"/blog/moon-v1.32","editUrl":"https://github.com/moonrepo/moon/tree/master/website/blog/2025-02-03_moon-v1.32.mdx","source":"@site/blog/2025-02-03_moon-v1.32.mdx","title":"moon v1.32 - Remote cache and built-in toolchain improvements","description":"In this release we focused primarily on remote caching and toolchain improvements.","date":"2025-02-03T00:00:00.000Z","tags":[{"inline":true,"label":"platform","permalink":"/blog/tags/platform"},{"inline":true,"label":"toolchain","permalink":"/blog/tags/toolchain"},{"inline":true,"label":"remote","permalink":"/blog/tags/remote"},{"inline":true,"label":"cache","permalink":"/blog/tags/cache"},{"inline":true,"label":"pkl","permalink":"/blog/tags/pkl"},{"inline":true,"label":"config","permalink":"/blog/tags/config"}],"readingTime":5.44,"hasTruncateMarker":true,"authors":[{"name":"Miles Johnson","title":"Founder, developer","url":"https://github.com/milesj","imageURL":"/img/authors/miles.jpg","key":"milesj","page":null}],"frontMatter":{"slug":"moon-v1.32","title":"moon v1.32 - Remote cache and built-in toolchain improvements","authors":["milesj"],"tags":["platform","toolchain","remote","cache","pkl","config"],"image":"./img/moon/v1.32.png"},"unlisted":false,"prevItem":{"title":"proto v0.47 - New backend system & asdf support","permalink":"/blog/proto-v0.47"},"nextItem":{"title":"proto v0.45 - New built-in tools and build from source","permalink":"/blog/proto-v0.45"}}')},43023:(e,n,o)=>{o.d(n,{R:()=>l,x:()=>a});var t=o(63696);const i={},s=t.createContext(i);function l(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(s.Provider,{value:n},e.children)}},84905:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>r,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>c});var t=o(2861),i=o(62540),s=o(43023);const l={slug:"moon-v1.32",title:"moon v1.32 - Remote cache and built-in toolchain improvements",authors:["milesj"],tags:["platform","toolchain","remote","cache","pkl","config"],image:"./img/moon/v1.32.png"},a=void 0,r={image:o(86642).A,authorsImageUrls:[void 0]},c=[{value:"Improved remote caching stability",id:"improved-remote-caching-stability",level:2},{value:"New settings",id:"new-settings",level:3},{value:"HTTP API support",id:"http-api-support",level:3},{value:"ByteStream support",id:"bytestream-support",level:3},{value:"Depot cloud hosting",id:"depot-cloud-hosting",level:3},{value:"Miscellaneous",id:"miscellaneous",level:3},{value:"Improved built-in toolchains",id:"improved-built-in-toolchains",level:2},{value:"Bun",id:"bun",level:3},{value:"Deno",id:"deno",level:3},{value:"Python",id:"python",level:3},{value:"Rust",id:"rust",level:3},{value:"Pkl configuration now available",id:"pkl-configuration-now-available",level:2},{value:"Other changes",id:"other-changes",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"In this release we focused primarily on remote caching and toolchain improvements."}),"\n",(0,i.jsx)(n.h2,{id:"improved-remote-caching-stability",children:"Improved remote caching stability"}),"\n",(0,i.jsx)(n.p,{children:"The main focus of this release was the stability of our remote caching implementation, by fixing all\nbugs and edge cases, and adding support for missing or new features."}),"\n",(0,i.jsx)(n.h3,{id:"new-settings",children:"New settings"}),"\n",(0,i.jsxs)(n.p,{children:["To support new features (below), we are introducing 2 new settings,\n",(0,i.jsx)(n.a,{href:"/docs/config/workspace#api",children:(0,i.jsx)(n.code,{children:"unstable_remote.api"})})," and\n",(0,i.jsx)(n.a,{href:"/docs/config/workspace#auth",children:(0,i.jsx)(n.code,{children:"unstable_remote.auth"})}),". The ",(0,i.jsx)(n.code,{children:"api"})," setting defines what API format the\nremote server supports and expects client requests to be sent in, either ",(0,i.jsx)(n.code,{children:"grpc"})," (default) or ",(0,i.jsx)(n.code,{children:"http"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"unstable_remote:\n  api: 'grpc'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["While the ",(0,i.jsx)(n.code,{children:"auth"})," setting does 2 things; allows HTTP headers to be configured that will be injected\ninto all gRPC/HTTP requests, and a token (via environment variable) to be used for bearer\nauthorization (instead of TLS/mTLS)."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"unstable_remote:\n  auth:\n    headers:\n      'X-Custom-Header': 'value'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"http-api-support",children:"HTTP API support"}),"\n",(0,i.jsxs)(n.p,{children:["If you don't want or can't use gRPC, we now support the\n",(0,i.jsx)(n.a,{href:"https://bazel.build/remote/caching#http-caching",children:"HTTP caching protocol"}),". This is a very simple API\nthat uploads action results to ",(0,i.jsx)(n.code,{children:"/ac/"})," endpoints, and output blobs to ",(0,i.jsx)(n.code,{children:"/cas/"})," endpoints (content\naddressable storage). The HTTP API is ",(0,i.jsx)(n.em,{children:"very"})," simple and does not support any of the features\nprovided by gRPC, like batch uploading/downloading, streaming, or missing blob detection."]}),"\n",(0,i.jsxs)(n.p,{children:["To use this protocol, set the new ",(0,i.jsx)(n.code,{children:"api"})," setting to ",(0,i.jsx)(n.code,{children:"http"}),", and configure an HTTP host."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/workspace.yml"',children:"unstable_remote:\n  api: 'http'\n  host: 'https://cache.yourhost.com'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"bytestream-support",children:"ByteStream support"}),"\n",(0,i.jsx)(n.p,{children:"We now support the ByteStream API for gRPC servers, which will automatically download and upload\nblobs larger than 4mb by streaming chunks of data. Previously, if we encountered a blob larger than\n4mb, we would abort uploading to the cache for that action, so subseqeuent runs would always be a\ncache miss."}),"\n",(0,i.jsx)(n.h3,{id:"depot-cloud-hosting",children:"Depot cloud hosting"}),"\n",(0,i.jsxs)(n.p,{children:["Our good friends at Depot (",(0,i.jsx)(n.a,{href:"https://depot.dev/",children:"depot.dev"}),") recently announced\n",(0,i.jsx)(n.a,{href:"https://depot.dev/blog/introducing-depot-cache",children:"Depot Cache"}),", a cloud-based caching solution that's\ncompatible with the Bazel remote execution/caching API. We were very excited to read this\nannouncement, and wanted to get it working in moon immediately. It took a bit of work, and uncovered\na lot of bugs on our end, but we eventually got it working!"]}),"\n",(0,i.jsx)(n.p,{children:"To make use of Depot Cache, create an account on their end, and then configure moon with the\nfollowing."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"unstable_remote:\n  host: 'grpcs://cache.depot.dev'\n  auth:\n    token: 'DEPOT_TOKEN'\n    # If you have multiple org's\n    headers:\n      'X-Depot-Org': '<id>'\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You'll need to set the ",(0,i.jsx)(n.code,{children:"DEPOT_TOKEN"})," environment variable on every machine that will use remote\ncaching.\n",(0,i.jsx)(n.a,{href:"/docs/guides/remote-cache#cloud-hosted-depot",children:"Learn more about this flow in our documentation"}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"moon itself now uses Depot Cache for its remote caching, and it has been working quite well! You can\nsee it in action within each pull request."})}),"\n",(0,i.jsx)(n.h3,{id:"miscellaneous",children:"Miscellaneous"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["You can now use ",(0,i.jsx)(n.code,{children:"http(s)"})," protocols for gRPC servers, instead of just ",(0,i.jsx)(n.code,{children:"grpc(s)"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Added timeouts and concurrency limits to our internal clients. In the future, we will also support\nretrying."}),"\n",(0,i.jsxs)(n.li,{children:["Added a ",(0,i.jsx)(n.code,{children:"MOON_DEBUG_REMOTE"})," environment variable, which can be used to debug internal errors for\ndiagnosing connection/integration issues."]}),"\n",(0,i.jsx)(n.li,{children:"Improved handling of TLS/mTLS connections."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"improved-built-in-toolchains",children:"Improved built-in toolchains"}),"\n",(0,i.jsx)(n.p,{children:"It's been quite some time since we've made any changes to our existing built-in toolchains, and\nsince there's been many updates in the ecosystem (like Deno v2), we felt it was time to do a pass on\nthem and introduce some improvements."}),"\n",(0,i.jsx)(n.h3,{id:"bun",children:"Bun"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Added support for the new text-based ",(0,i.jsx)(n.code,{children:"bun.lock"})," file in\n",(0,i.jsx)(n.a,{href:"https://bun.sh/blog/bun-v1.2#introducing-bun-lock",children:"Bun v1.2"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["We do our best to detect between the text and binary formats, but we suggest configuring\n",(0,i.jsx)(n.code,{children:"--save-text-lockfile"})," in ",(0,i.jsx)(n.a,{href:"/docs/config/toolchain#installargs",children:(0,i.jsx)(n.code,{children:"bun.installArgs"})})," to be\nexplicit."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"deno",children:"Deno"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Added support for ",(0,i.jsx)(n.a,{href:"https://deno.com/blog/v2.0",children:"Deno v2"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Now supports all lockfile versions (1-4), thanks to the official ",(0,i.jsx)(n.code,{children:"deno_lockfile"})," crate."]}),"\n",(0,i.jsxs)(n.li,{children:["Now uses ",(0,i.jsx)(n.code,{children:"deno install"})," in v2+ instead of ",(0,i.jsx)(n.code,{children:"deno cache"})," that was used in v1."]}),"\n",(0,i.jsxs)(n.li,{children:["Added a new ",(0,i.jsx)(n.a,{href:"/docs/config/toolchain#installargs-1",children:(0,i.jsx)(n.code,{children:"deno.installArgs"})})," setting."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Added support for workspaces that were introduced in ",(0,i.jsx)(n.a,{href:"https://deno.com/blog/v1.45",children:"Deno v1.45"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"When a project is within a workspace, it will now install dependencies once in the workspace,\ninstead of in each project."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"python",children:"Python"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Added unstable ",(0,i.jsx)(n.a,{href:"https://docs.astral.sh/uv/",children:"uv support"}),". Can be enabled with the new\n",(0,i.jsx)(n.a,{href:"/docs/config/toolchain#packagemanager-1",children:(0,i.jsx)(n.code,{children:"python.packageManager"})})," and\n",(0,i.jsx)(n.a,{href:"/docs/config/toolchain#uv",children:(0,i.jsx)(n.code,{children:"python.uv"})})," settings.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Right now, has basic toolchain support, including dependency installs and virtual environments."}),"\n",(0,i.jsxs)(n.li,{children:["Uses ",(0,i.jsx)(n.code,{children:"uv venv"})," instead of ",(0,i.jsx)(n.code,{children:"python venv"})," and ",(0,i.jsx)(n.code,{children:"uv sync"})," instead of ",(0,i.jsx)(n.code,{children:"pip install"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Relies on ",(0,i.jsx)(n.code,{children:"pyproject.toml"})," and ",(0,i.jsx)(n.code,{children:"uv.lock"})," instead of ",(0,i.jsx)(n.code,{children:"requirements.txt"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Renamed the ",(0,i.jsx)(n.code,{children:"python.rootRequirementsOnly"})," setting to\n",(0,i.jsx)(n.a,{href:"/docs/config/toolchain#rootvenvonly",children:(0,i.jsx)(n.code,{children:"python.rootVenvOnly"})}),". Open for discussion on the name of\nthis setting."]}),"\n",(0,i.jsxs)(n.li,{children:["Will now inherit versions from the root ",(0,i.jsx)(n.code,{children:".prototools"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title=".moon/toolchain.yml"',children:"python:\n  version: '3.12.0'\n  packageManager: 'uv'\n  uv:\n    version: '0.5.26'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"rust",children:"Rust"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The root-level project is now properly taken into account when detecting if a project is within\nthe Cargo workspace."}),"\n",(0,i.jsxs)(n.li,{children:["Project dependencies (",(0,i.jsx)(n.code,{children:"dependsOn"}),") are now automatically inferred from ",(0,i.jsx)(n.code,{children:"Cargo.toml"})," dependencies\n(only ",(0,i.jsx)(n.code,{children:"path"})," allowed)."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"pkl-configuration-now-available",children:"Pkl configuration now available"}),"\n",(0,i.jsxs)(n.p,{children:["In ",(0,i.jsx)(n.a,{href:"./moon-v1.29",children:"moon v1.29"})," we introduced support for Pkl-based (",(0,i.jsx)(n.code,{children:".pkl"}),") configuration as an\nalternative to YAML (",(0,i.jsx)(n.code,{children:".yml"}),"), but it was hidden behind an experimental flag. Going forward, you can\nnow use Pkl without having to enable the experimental flag, and can remove any references to\n",(0,i.jsx)(n.code,{children:"--experimentPklConfig"})," or ",(0,i.jsx)(n.code,{children:"MOON_EXPERIMENT_PKL_CONFIG"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Additionally, we now have ",(0,i.jsx)(n.a,{href:"/docs/guides/pkl-config",children:"official documentation on what Pkl is"}),", how to\nuse it, and some examples of what it looks like. Check it out!"]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"Based on feedback from the community, and our current thoughts on the configuration problem, at this\npoint in time, we plan to support multiple configuration formats instead of choosing one, and will\nmost likely include support for JSON/JSONC in v2. We're also open to other formats that may work\nwell in moon, and are compatible with our current codebase."})}),"\n",(0,i.jsx)(n.h2,{id:"other-changes",children:"Other changes"}),"\n",(0,i.jsxs)(n.p,{children:["View the ",(0,i.jsx)(n.a,{href:"https://github.com/moonrepo/moon/releases/tag/v1.32.0",children:"official release"})," for a full list\nof changes."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Added unstable support for multiple package workspaces when installing dependencies and resolving\nlockfiles."}),"\n",(0,i.jsx)(n.li,{children:"Reworked child process handling to better handle signals and shutdown accordingly. Additionally,\nwhen the pipeline receives a signal, we now display the status that shutdown the pipeline in the\nsummary."}),"\n",(0,i.jsxs)(n.li,{children:["Reworked the new task ",(0,i.jsx)(n.code,{children:"inferInputs"})," option to not infer environment variables from popular CI/CD\nproviders, as those values constantly change, causing tasks to always be affected. If you would\nlike to reference these values, add them as an explicit inputs."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},86642:(e,n,o)=>{o.d(n,{A:()=>t});const t=o.p+"assets/images/v1.32-64d1722d33e0bcffa7ca447be72c2724.png"}}]);